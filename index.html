<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✨ Premium Bingo Experience</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
            position: relative;
            box-sizing: border-box;
        }

        /* Simple background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.1) 1px, transparent 1px),
                        radial-gradient(circle at 80% 40%, rgba(255,255,255,0.08) 1px, transparent 1px),
                        radial-gradient(circle at 40% 80%, rgba(255,255,255,0.06) 1px, transparent 1px);
            background-size: 100px 100px, 150px 150px, 200px 200px;
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Header with simple styling */
        h1 {
            font-size: 4rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 40px;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* Glass morphism cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .glass-card:hover::before {
            left: 100%;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
        }

        /* Role selection with premium styling */
        .role-selection {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 70vh;
        }

        .login-card {
            padding: 50px;
            text-align: center;
            max-width: 450px;
            width: 100%;
            animation: slideUp 0.8s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-card h2 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-card p {
            font-size: 1.1rem;
            margin-bottom: 40px;
            opacity: 0.9;
            font-weight: 300;
        }

        /* Premium buttons */
        .premium-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.2rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin: 10px;
            min-width: 200px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .premium-btn:disabled {
            cursor: not-allowed;
            filter: grayscale(50%);
            opacity: 0.7;
        }

        .premium-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .premium-btn:hover::before {
            left: 100%;
        }

        .premium-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .premium-btn.organizer {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }

        .premium-btn.organizer:hover {
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.4);
        }

        .premium-btn.participant {
            background: linear-gradient(45deg, #48bb78, #38a169);
            box-shadow: 0 10px 30px rgba(72, 187, 120, 0.3);
        }

        .premium-btn.participant:hover {
            box-shadow: 0 15px 40px rgba(72, 187, 120, 0.4);
        }

        /* Premium inputs */
        .premium-input {
            width: 100%;
            padding: 20px;
            font-size: 1.2rem;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .premium-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .premium-input:focus {
            outline: none;
            border-color: #ffd700;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        /* Game area with advanced layout */
        .game-area {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 40px;
            align-items: start;
            margin-bottom: 30px;
        }

        .participant-game-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 40px;
            align-items: start;
        }

        /* Bingo card with 3D effect */
        .bingo-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .bingo-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            animation: rotate 10s linear infinite;
            z-index: -1;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .card-header {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .letter {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            font-size: 1.8rem;
            font-weight: 800;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .letter:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }

        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .bingo-cell {
            aspect-ratio: 1;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            font-weight: 700;
            color: #333;
            cursor: default;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .bingo-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .bingo-cell.marked {
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
            border-color: #38a169;
            animation: pulse 0.6s ease-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .bingo-cell.marked::after {
            content: '✓';
            position: absolute;
            font-size: 2rem;
            animation: checkmark 0.5s ease-out;
        }

        @keyframes checkmark {
            0% { opacity: 0; transform: scale(0); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Control panel with futuristic design */
        .controls {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border-radius: 25px;
            padding: 30px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
        }

        .current-number {
            font-size: 4.5rem;
            font-weight: 900;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            border-radius: 50%;
            width: 140px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            box-shadow: 0 20px 40px rgba(255, 215, 0, 0.3);
            position: relative;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 20px 40px rgba(255, 215, 0, 0.3); }
            to { box-shadow: 0 25px 50px rgba(255, 215, 0, 0.5); }
        }

        .current-number::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
            border-radius: 50%;
            z-index: -1;
            animation: rotate 3s linear infinite;
        }

        /* Participant cards with premium styling */
        .participants-view {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .participant-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .participant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
        }

        .participant-card.inactive {
            opacity: 0.6;
            filter: grayscale(50%);
        }

        .participant-header {
            text-align: center;
            margin-bottom: 15px;
            font-weight: 700;
            font-size: 1.2rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .participant-header.inactive {
            background: linear-gradient(45deg, #a0aec0, #718096);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .participant-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 3px;
        }

        .participant-cell {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            transition: all 0.3s ease;
        }

        .participant-cell.marked {
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
            border-color: #38a169;
        }

        .participant-cell.winner {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            border-color: #f6d55c;
            animation: winner-glow 1s ease-in-out infinite alternate;
        }

        @keyframes winner-glow {
            from { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
            to { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
        }

        /* Toggle buttons with modern design */
        .view-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 5px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .toggle-btn {
            background: transparent;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1rem;
        }

        .toggle-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .toggle-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Win message with spectacular animation */
        .win-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
            padding: 50px;
            border-radius: 25px;
            font-size: 2.5rem;
            font-weight: 800;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            text-align: center;
            animation: winAnimation 0.8s ease-out;
            border: 3px solid #ffd700;
        }

        @keyframes winAnimation {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5) rotate(-10deg);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1) rotate(5deg);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
            }
        }

        /* Called numbers with elegant styling */
        .called-numbers {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            margin-top: 25px;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .called-numbers h3 {
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 700;
            color: #ffd700;
            text-align: center;
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
        }

        .called-number {
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            padding: 12px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .called-number:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.2);
        }

        /* Organizer info bar */
        .organizer-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logout-button {
            background: linear-gradient(45deg, #e53e3e, #c53030);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(229, 62, 62, 0.3);
        }

        .logout-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(229, 62, 62, 0.4);
        }

        /* Approval system styling */
        .approval-display {
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.2), rgba(255, 237, 78, 0.1));
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); }
        }

        .approval-display h3 {
            margin: 0 0 15px 0;
            color: #ffd700;
            font-weight: 700;
            text-align: center;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            .game-area,
            .participant-game-layout {
                grid-template-columns: 1fr;
                gap: 25px;
            }
            
            .login-card {
                padding: 30px 25px;
                margin: 0 15px;
            }
            
            .current-number {
                font-size: 3.5rem;
                width: 120px;
                height: 120px;
            }
            
            .participants-view {
                grid-template-columns: 1fr;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #5a67d8, #6b46c1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>K2 BINGO GAME !!</h1>
        
        <div class="role-selection" id="roleSelection">
            <div class="login-card glass-card">
                <h2>🎯 Choose Your Adventure</h2>
                <p>Select your role to begin the ultimate bingo experience</p>
                <button onclick="showLogin('organizer')" class="premium-btn organizer">🎯 Game Master</button>
                <button onclick="showLogin('participant')" class="premium-btn participant">👥 Player</button>
            </div>
        </div>

        <div class="organizer-login" id="organizerLogin" style="display: none;">
            <div class="role-selection">
                <div class="login-card glass-card">
                    <h2>🎯 Master Control</h2>
                    <p>Enter your exclusive access code to control the game</p>
                    <input type="text" id="organizerOtpInput" placeholder="Enter 4-digit code" maxlength="4" class="premium-input">
                    <button onclick="verifyOrganizerOTP()" class="premium-btn organizer">Verify Access</button>
                    <button onclick="backToRoleSelection()" class="premium-btn" style="background: linear-gradient(45deg, #e53e3e, #c53030); margin-top: 15px;">← Back</button>
                </div>
            </div>
        </div>

        <div class="participant-login" id="participantLogin" style="display: none;">
            <div class="role-selection">
                <div class="login-card glass-card">
                    <h2>👥 Join the Game</h2>
                    <p>Enter your details to join this premium bingo experience</p>
                    <input type="text" id="participantNameInput" placeholder="Enter your name" class="premium-input">
                    <input type="text" id="participantOtpInput" placeholder="Enter 4-digit code" maxlength="4" class="premium-input">
                    <button onclick="verifyParticipantOTP()" class="premium-btn participant">Join Game</button>
                    <button onclick="backToRoleSelection()" class="premium-btn" style="background: linear-gradient(45deg, #e53e3e, #c53030); margin-top: 15px;">← Back</button>
                </div>
            </div>
        </div>

        <div class="view-toggle" id="viewToggle" style="display: none;">
            <button class="toggle-btn active" onclick="switchView('organizer')">🎯 Control Center</button>
            <button class="toggle-btn" onclick="switchView('participants')">👥 Players View</button>
        </div>

        <div class="organizer-area" id="organizerArea" style="display: none;">
            <div class="controls glass-card" style="max-width: 450px; margin: 0 auto;">
                <div class="organizer-info">
                    <span style="font-weight: 600;">🎮 Game Master (<span id="participantCount">0</span> players online)</span>
                    <button onclick="logout()" class="logout-button">Logout</button>
                </div>
                
                <div class="approval-display" id="approvalDisplay">
                    <h3 id="approvalTitle">📞 Call Requests</h3>
                    <div id="approvalContent" style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 1.1rem; font-weight: 600; text-align: center; opacity: 0.7;" id="requestingParticipant">No pending requests</p>
                        <div id="approvalButtons" style="display: none; margin-top: 15px;">
                            <div style="display: flex; gap: 15px;">
                                <button onclick="approveCall()" class="premium-btn participant" style="flex: 1; padding: 12px;">✓ Approve</button>
                                <button onclick="denyCall()" class="premium-btn" style="background: linear-gradient(45deg, #e53e3e, #c53030); flex: 1; padding: 12px;">✗ Deny</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="current-number" id="currentNumber">?</div>
                
                <button class="premium-btn" onclick="callNumber()" id="organizerCallButton" style="width: 100%; margin-bottom: 15px;">🎲 Call Next Number</button>
                <button class="premium-btn" onclick="resetGame()" style="background: linear-gradient(45deg, #e53e3e, #c53030); width: 100%;">🔄 New Game</button>
                
                <div class="called-numbers">
                    <h3>📋 Called Numbers</h3>
                    <div class="numbers-grid" id="calledNumbers">
                        </div>
                </div>
            </div>
        </div>

        <div class="participant-area" id="participantArea" style="display: none;">
            <div class="participant-game-layout">
                <div class="bingo-card glass-card">
                    <div class="card-header">
                        <div class="letter">B</div>
                        <div class="letter">I</div>
                        <div class="letter">N</div>
                        <div class="letter">G</div>
                        <div class="letter">O</div>
                    </div>
                    <div class="bingo-grid" id="participantBingoGrid">
                        </div>
                </div>
                
                <div class="controls glass-card">
                    <div class="organizer-info">
                        <span style="font-weight: 600;">🎮 Player: <span id="playerNameDisplay"></span></span>
                        <button onclick="logout()" class="logout-button">Logout</button>
                    </div>
                    
                    <div class="current-number" id="participantCurrentNumber">?</div>
                    
                    <div class="approval-section" id="participantApprovalSection">
                        <button class="premium-btn participant" id="requestCallButton" onclick="requestCall()" style="width: 100%; margin-bottom: 20px;">🎲 Request Next Call</button>
                        <div id="waitingMessage" style="display: none; text-align: center; padding: 20px; background: rgba(255,215,0,0.2); border-radius: 15px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                            <p style="margin: 0; color: #ffd700; font-weight: 600;">⏳ Awaiting master approval...</p>
                        </div>
                    </div>
                    
                    <div class="called-numbers">
                        <h3>📋 Called Numbers</h3>
                        <div class="numbers-grid" id="participantCalledNumbers">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="participants-view" id="participantsView" style="display: none;">
            </div>
    </div>
    
    <div class="win-message" id="winMessage">
        🎉 BINGO! 🎉<br>
        <small style="font-size: 1.2rem;">You Win!</small>
    </div>

    <script>
        // --- START: NEW/IMPROVED CODE ---

        // Constants for localStorage keys
        const BINGO_PARTICIPANTS_KEY = 'bingoParticipants';
        const BINGO_CALLED_NUMBERS_KEY = 'bingoCalledNumbers';
        const BINGO_GAME_STATE_KEY = 'bingoGameState';
        const BINGO_CALL_REQUEST_KEY = 'bingoCallRequest';
        const BINGO_ACTIVE_SESSIONS_KEY = 'bingoActiveSessions';

        // Global state variables
        let availableNumbers = [];
        let userRole = null;
        let currentParticipantName = null;
        let currentParticipantCard = [];
        let currentView = 'organizer';

        // Intervals for session management
        let heartbeatInterval = null;
        let sessionCheckInterval = null;

        // --- END: NEW/IMPROVED CODE ---

        // Load game data from localStorage
        function getGameData() {
            const participants = JSON.parse(localStorage.getItem(BINGO_PARTICIPANTS_KEY) || '[]');
            const calledNumbers = JSON.parse(localStorage.getItem(BINGO_CALLED_NUMBERS_KEY) || '[]');
            const gameState = JSON.parse(localStorage.getItem(BINGO_GAME_STATE_KEY) || '{}');
            return { participants, calledNumbers, gameState };
        }

        // Save game state to localStorage
        function saveGameState(participants, calledNumbers, gameState) {
            localStorage.setItem(BINGO_PARTICIPANTS_KEY, JSON.stringify(participants));
            localStorage.setItem(BINGO_CALLED_NUMBERS_KEY, JSON.stringify(calledNumbers));
            localStorage.setItem(BINGO_GAME_STATE_KEY, JSON.stringify(gameState));
        }

        function syncGameState() {
            const data = getGameData();
            
            // Rebuild available numbers
            availableNumbers = [];
            for (let i = 1; i <= 25; i++) {
                if (!data.calledNumbers.includes(i)) {
                    availableNumbers.push(i);
                }
            }

            // Update UI for both roles
            updateCalledNumbersDisplay(data.calledNumbers);
            updateParticipantCounts(data.participants);

            const currentNumber = data.gameState.gameWinner ? 'K2⭐' : data.gameState.currentNumber || '?';
            const isWinner = !!data.gameState.gameWinner;

            if (document.getElementById('currentNumber')) {
                updateCurrentNumberDisplay('currentNumber', currentNumber, isWinner);
            }
            if (document.getElementById('participantCurrentNumber')) {
                updateCurrentNumberDisplay('participantCurrentNumber', currentNumber, isWinner);
            }

            // Role-specific UI updates
            if (userRole === 'organizer') {
                document.getElementById('organizerCallButton').disabled = data.gameState.gameWon || availableNumbers.length === 0;
                renderParticipants(data.participants, data.gameState.gameWinner);
            } else if (userRole === 'participant') {
                document.getElementById('requestCallButton').disabled = data.gameState.gameWon || availableNumbers.length === 0;
                generateParticipantBingoCard(); // Regenerate card to show marked numbers
            }
            
            if (data.gameState.gameWon && data.gameState.gameWinner) {
                showWinMessage(data.gameState.gameWinner);
            } else {
                 document.getElementById('winMessage').style.display = 'none';
            }
        }

        // Generate participant's own bingo card
        function generateParticipantBingoCard() {
            const grid = document.getElementById('participantBingoGrid');
            if (!grid) return;
            grid.innerHTML = '';
            
            const { participants, calledNumbers } = getGameData();
            const savedParticipant = participants.find(p => p.name === currentParticipantName);

            if (!savedParticipant) return;
            currentParticipantCard = savedParticipant.card;

            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'bingo-cell';
                    const cellData = currentParticipantCard[row][col];
                    cell.textContent = cellData.number;
                    if (calledNumbers.includes(cellData.number)) {
                        cell.classList.add('marked');
                    }
                    grid.appendChild(cell);
                }
            }
        }
        
        // Add a new participant
        function addParticipant(name) {
            const { participants, calledNumbers, gameState } = getGameData();
            if (participants.some(p => p.name === name)) return;

            const columns = [
                getRandomNumbers(1, 5, 5), getRandomNumbers(6, 10, 5),
                getRandomNumbers(11, 15, 5), getRandomNumbers(16, 20, 5),
                getRandomNumbers(21, 25, 5)
            ];
            const participantCard = [];
            for (let row = 0; row < 5; row++) {
                participantCard[row] = [];
                for (let col = 0; col < 5; col++) {
                    participantCard[row][col] = { number: columns[col][row] };
                }
            }
            
            participants.push({ name: name, card: participantCard });
            saveGameState(participants, calledNumbers, gameState);
        }

        // Helper function to check win status of a card
        function checkCardWinStatus(card, calledNumbers) {
            const isMarked = (num) => calledNumbers.includes(num);

            // Check rows
            for (let row = 0; row < 5; row++) {
                if (card[row].every(cell => isMarked(cell.number))) return true;
            }
            // Check columns
            for (let col = 0; col < 5; col++) {
                if (card.every(row => isMarked(row[col].number))) return true;
            }
            // Check diagonals
            if (card.every((row, index) => isMarked(row[index].number)) ||
                card.every((row, index) => isMarked(row[4 - index].number))) return true;
                
            return false;
        }

        // Update participant counts display
        function updateParticipantCounts(participants) {
            const countElement = document.getElementById('participantCount');
            if (countElement) countElement.textContent = participants.length;
        }

        // Get random numbers for a column
        function getRandomNumbers(min, max, count) {
            const numbers = [], available = [];
            for (let i = min; i <= max; i++) available.push(i);
            for (let i = 0; i < count; i++) {
                const randomIndex = Math.floor(Math.random() * available.length);
                numbers.push(available.splice(randomIndex, 1)[0]);
            }
            return numbers;
        }
        
        // Request to call next number
        function requestCall() {
            const { gameState } = getGameData();
            if (gameState.gameWon || availableNumbers.length === 0) return;
            
            localStorage.setItem(BINGO_CALL_REQUEST_KEY, JSON.stringify({ name: currentParticipantName }));
            document.getElementById('requestCallButton').disabled = true;
            document.getElementById('waitingMessage').style.display = 'block';
        }

        // Show call request to organizer
        function showCallRequest(requestingName) {
            document.getElementById('requestingParticipant').textContent = `${requestingName} wants to call the next number`;
            document.getElementById('requestingParticipant').style.opacity = '1';
            document.getElementById('approvalButtons').style.display = 'block';
        }

        function approveCall() {
            localStorage.removeItem(BINGO_CALL_REQUEST_KEY);
            callNumber();
        }

        function denyCall() {
            localStorage.removeItem(BINGO_CALL_REQUEST_KEY);
        }

        function resetApprovalDisplay() {
            document.getElementById('requestingParticipant').textContent = 'No pending requests';
            document.getElementById('requestingParticipant').style.opacity = '0.7';
            document.getElementById('approvalButtons').style.display = 'none';
        }

        function resetParticipantRequestUI() {
            const { gameState } = getGameData();
            if (document.getElementById('requestCallButton')) {
                document.getElementById('requestCallButton').disabled = gameState.gameWon;
                document.getElementById('waitingMessage').style.display = 'none';
            }
        }

        function callNumber() {
            let { participants, calledNumbers, gameState } = getGameData();
            if (gameState.gameWon || availableNumbers.length === 0) return;

            const randomIndex = Math.floor(Math.random() * availableNumbers.length);
            const number = availableNumbers.splice(randomIndex, 1)[0];
            calledNumbers.push(number);

            gameState.currentNumber = number;

            // Check for winners
            let newWinner = null;
            participants.forEach(p => {
                if (checkCardWinStatus(p.card, calledNumbers)) {
                    if (!gameState.gameWinner) {
                        newWinner = p.name;
                    }
                }
            });

            if (newWinner) {
                gameState.gameWinner = newWinner;
                gameState.gameWon = true;
            }
            
            saveGameState(participants, calledNumbers, gameState);
        }

        function renderParticipants(participants, gameWinner) {
            const container = document.getElementById('participantsView');
            if (!container) return;
            container.innerHTML = '';
            
            if (participants.length === 0) {
                container.innerHTML = `<div class="glass-card" style="padding: 40px; text-align: center; grid-column: 1 / -1;">
                                         <h3 style="color: #ffd700; margin: 0;">👥 No Players Online</h3>
                                         <p style="margin: 10px 0 0 0; opacity: 0.8;">Players will appear here when they join the game.</p>
                                       </div>`;
                return;
            }
            
            const { calledNumbers } = getGameData();
            const callRequest = JSON.parse(localStorage.getItem(BINGO_CALL_REQUEST_KEY) || 'null');
            
            participants.forEach(participant => {
                const card = document.createElement('div');
                card.className = 'participant-card glass-card';
                const hasWon = gameWinner === participant.name;
                const isRequesting = callRequest && callRequest.name === participant.name;

                card.innerHTML = `
                    <div class="participant-header">
                        🟢 ${participant.name}
                        ${hasWon ? ' 🏆 K2 STAR!' : ''}
                        ${isRequesting ? ' 📞 REQUESTING' : ''}
                    </div>
                    <div class="participant-grid">
                        ${participant.card.flat().map(cell => `
                            <div class="participant-cell ${calledNumbers.includes(cell.number) ? 'marked' : ''} ${hasWon ? 'winner' : ''}">
                                ${cell.number}
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateCalledNumbersDisplay(calledNumbers) {
            const containers = [document.getElementById('calledNumbers'), document.getElementById('participantCalledNumbers')];
            containers.forEach(container => {
                if (container) {
                    container.innerHTML = calledNumbers.map(n => `<div class="called-number">${n}</div>`).join('');
                }
            });
        }

        function updateCurrentNumberDisplay(elementId, text, isWinner) {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.textContent = text;
            if (isWinner) {
                element.style.background = 'linear-gradient(45deg, #ffd700, #ffed4e)';
                element.style.color = '#333';
            } else {
                element.style.background = '';
                element.style.color = '';
            }
        }
        
        function showWinMessage(winnerName) {
            const winMessage = document.getElementById('winMessage');
            winMessage.innerHTML = `🎉 BINGO! 🎉<br><small style="font-size: 1.2rem;">${winnerName} is the K2 STAR Winner! ⭐</small>`;
            winMessage.style.display = 'block';
        }

        function resetGame() {
            let { participants } = getGameData();
            // Keep participants but reset game state
            saveGameState(participants, [], {
                gameWon: false,
                gameWinner: null,
                currentNumber: '?'
            });
            // Clear any pending call requests
            localStorage.removeItem(BINGO_CALL_REQUEST_KEY);
        }

        function showLogin(role) {
            document.getElementById('roleSelection').style.display = 'none';
            if (role === 'organizer') {
                document.getElementById('organizerLogin').style.display = 'flex';
            } else {
                document.getElementById('participantLogin').style.display = 'flex';
            }
        }

        function backToRoleSelection() {
            document.getElementById('organizerLogin').style.display = 'none';
            document.getElementById('participantLogin').style.display = 'none';
            document.getElementById('roleSelection').style.display = 'flex';
        }

        function switchView(view) {
            if (userRole !== 'organizer') return;
            currentView = view;
            const toggleBtns = document.querySelectorAll('.toggle-btn');
            toggleBtns.forEach(btn => btn.classList.remove('active'));
            
            if (view === 'organizer') {
                document.getElementById('organizerArea').style.display = 'block';
                document.getElementById('participantsView').style.display = 'none';
                toggleBtns[0].classList.add('active');
            } else {
                document.getElementById('organizerArea').style.display = 'none';
                document.getElementById('participantsView').style.display = 'grid';
                toggleBtns[1].classList.add('active');
                syncGameState(); // Always refresh view
            }
        }

        function verifyOrganizerOTP() {
            const otpInput = document.getElementById('organizerOtpInput');
            if (otpInput.value === '9999') {
                userRole = 'organizer';
                currentView = 'organizer';
                
                document.getElementById('organizerLogin').style.display = 'none';
                document.getElementById('viewToggle').style.display = 'flex';
                document.getElementById('organizerArea').style.display = 'block';
                
                syncGameState();
                startSessionChecker();
            } else {
                showError(otpInput);
            }
        }

        function verifyParticipantOTP() {
            const nameInput = document.getElementById('participantNameInput');
            const otpInput = document.getElementById('participantOtpInput');
            const enteredName = nameInput.value.trim();
            const enteredOTP = otpInput.value;
            
            if (!enteredName) {
                showError(nameInput, 'Please enter your name');
                return;
            }
            
            const { participants } = getGameData();
            if (participants.some(p => p.name.toLowerCase() === enteredName.toLowerCase())) {
                showError(nameInput, 'Name already taken');
                nameInput.value = '';
                return;
            }
            
            if (enteredOTP === '5555') {
                currentParticipantName = enteredName;
                userRole = 'participant';
                
                document.getElementById('participantLogin').style.display = 'none';
                document.getElementById('participantArea').style.display = 'block';
                document.getElementById('playerNameDisplay').textContent = enteredName;
                
                addParticipant(enteredName);
                startParticipantSession(enteredName);
                syncGameState();

            } else {
                showError(otpInput);
            }
        }

        function showError(inputElement, message = 'Invalid code') {
            inputElement.style.borderColor = '#e53e3e';
            inputElement.style.background = 'rgba(229, 62, 62, 0.1)';
            setTimeout(() => {
                inputElement.style.borderColor = 'rgba(255,255,255,0.2)';
                inputElement.style.background = 'rgba(255,255,255,0.1)';
            }, 2000);
            inputElement.value = '';
            inputElement.placeholder = message;
        }

        function logout() {
            if (userRole === 'participant') {
                endParticipantSession(currentParticipantName);
                currentParticipantName = null;
            } else if (userRole === 'organizer') {
                stopSessionChecker();
            }
            
            userRole = null;
            
            document.getElementById('organizerArea').style.display = 'none';
            document.getElementById('participantArea').style.display = 'none';
            document.getElementById('participantsView').style.display = 'none';
            document.getElementById('viewToggle').style.display = 'none';
            document.getElementById('roleSelection').style.display = 'flex';
            
            document.getElementById('organizerOtpInput').value = '';
            document.getElementById('participantNameInput').value = '';
            document.getElementById('participantOtpInput').value = '';
        }

        // --- START: NEW SESSION MANAGEMENT CODE ---

        function startParticipantSession(name) {
            heartbeatInterval = setInterval(() => {
                let sessions = JSON.parse(localStorage.getItem(BINGO_ACTIVE_SESSIONS_KEY) || '[]');
                let mySession = sessions.find(s => s.name === name);
                if (mySession) {
                    mySession.timestamp = Date.now();
                } else {
                    sessions.push({ name: name, timestamp: Date.now() });
                }
                localStorage.setItem(BINGO_ACTIVE_SESSIONS_KEY, JSON.stringify(sessions));
            }, 5000); // Heartbeat every 5 seconds

            window.addEventListener('beforeunload', () => endParticipantSession(name, false));
        }

        function endParticipantSession(name, doFullLogout = true) {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = null;

            let sessions = JSON.parse(localStorage.getItem(BINGO_ACTIVE_SESSIONS_KEY) || '[]');
            sessions = sessions.filter(s => s.name !== name);
            localStorage.setItem(BINGO_ACTIVE_SESSIONS_KEY, JSON.stringify(sessions));
            
            if (doFullLogout) {
                removeParticipant(name);
            }
        }

        function startSessionChecker() {
            if (sessionCheckInterval) clearInterval(sessionCheckInterval);
            sessionCheckInterval = setInterval(() => {
                const sessions = JSON.parse(localStorage.getItem(BINGO_ACTIVE_SESSIONS_KEY) || '[]');
                const { participants, calledNumbers, gameState } = getGameData();
                const now = Date.now();
                const INACTIVITY_THRESHOLD = 15000; // 15 seconds

                const activeNames = sessions.filter(s => (now - s.timestamp) < INACTIVITY_THRESHOLD).map(s => s.name);
                const updatedParticipants = participants.filter(p => activeNames.includes(p.name));
                
                if (updatedParticipants.length !== participants.length) {
                    // Also clear call request if the requester disconnected
                    const request = JSON.parse(localStorage.getItem(BINGO_CALL_REQUEST_KEY) || 'null');
                    if (request && !activeNames.includes(request.name)) {
                        localStorage.removeItem(BINGO_CALL_REQUEST_KEY);
                    }
                    saveGameState(updatedParticipants, calledNumbers, gameState);
                }
            }, 10000); // Check every 10 seconds
        }
        
        function stopSessionChecker() {
             if (sessionCheckInterval) clearInterval(sessionCheckInterval);
             sessionCheckInterval = null;
        }

        function removeParticipant(name) {
            const { participants, calledNumbers, gameState } = getGameData();
            const updatedParticipants = participants.filter(p => p.name !== name);
            saveGameState(updatedParticipants, calledNumbers, gameState);
        }
        
        // --- END: NEW SESSION MANAGEMENT CODE ---

        // Main event listener for cross-tab synchronization
        window.addEventListener('storage', (e) => {
            if ([BINGO_PARTICIPANTS_KEY, BINGO_CALLED_NUMBERS_KEY, BINGO_GAME_STATE_KEY].includes(e.key)) {
                syncGameState();
            }
            
            if (e.key === BINGO_CALL_REQUEST_KEY) {
                const request = JSON.parse(localStorage.getItem(BINGO_CALL_REQUEST_KEY) || 'null');
                if (userRole === 'organizer') {
                    if (request) {
                        showCallRequest(request.name);
                    } else {
                        resetApprovalDisplay();
                    }
                    // Re-render participants to show/hide "requesting" label
                    const { participants, gameState } = getGameData();
                    renderParticipants(participants, gameState.gameWinner);
                }
                if (userRole === 'participant' && !request) {
                    resetParticipantRequestUI();
                }
            }
        });
        
        // Allow Enter key to verify OTP
        document.addEventListener('DOMContentLoaded', function() {
            const organizerOtpInput = document.getElementById('organizerOtpInput');
            organizerOtpInput.addEventListener('keypress', (e) => e.key === 'Enter' && verifyOrganizerOTP());
            
            const participantNameInput = document.getElementById('participantNameInput');
            participantNameInput.addEventListener('keypress', (e) => e.key === 'Enter' && document.getElementById('participantOtpInput').focus());

            const participantOtpInput = document.getElementById('participantOtpInput');
            participantOtpInput.addEventListener('keypress', (e) => e.key === 'Enter' && verifyParticipantOTP());
        });
    </script>
</body>
</html>