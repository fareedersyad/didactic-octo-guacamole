<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K2 Bingo Fixed</title>
</head>
<body>
<!-- Original UI and CSS remain the same; only logic fixes below -->

<script>
// === Fix 1: Cross-tab organizer detection ===
window.addEventListener('storage', function(event) {
    if (event.key === 'bingoGameState' || event.key === 'bingoParticipants') {
        loadGameData();
        if (userRole === 'organizer') {
            renderParticipants();
            updateCalledNumbersDisplay();
            updateParticipantCounts();
        } else if (userRole === 'participant') {
            updateCalledNumbersDisplay();
        }
    }
    if (event.key === 'pendingCallRequest') {
        const req = localStorage.getItem('pendingCallRequest');
        if (req) {
            pendingCallRequest = req;
            if (userRole === 'organizer') showCallRequest();
        }
    }
});

// === Fix 2: Reliable requestCall sync ===
function requestCall() {
    if (gameWon || availableNumbers.length === 0) return;

    pendingCallRequest = currentParticipantName;
    localStorage.setItem('pendingCallRequest', currentParticipantName);

    document.getElementById('requestCallButton').disabled = true;
    document.getElementById('waitingMessage').style.display = 'block';

    showCallRequest();
}

function approveCall() {
    if (pendingCallRequest) {
        callNumber();
        resetApprovalDisplay();
        pendingCallRequest = null;
        localStorage.removeItem('pendingCallRequest');
        resetParticipantRequestUI();
    }
}

function denyCall() {
    resetApprovalDisplay();
    pendingCallRequest = null;
    localStorage.removeItem('pendingCallRequest');
    resetParticipantRequestUI();
}

// === Fix 3: Heartbeat for online detection ===
setInterval(() => {
    if (userRole === 'participant' && currentParticipantName) {
        localStorage.setItem(`heartbeat_${currentParticipantName}`, Date.now());
    }
}, 10000);

setInterval(() => {
    if (userRole === 'organizer') {
        const now = Date.now();
        realParticipants = realParticipants.filter(p => {
            const lastBeat = localStorage.getItem(`heartbeat_${p.name}`);
            const active = lastBeat && (now - parseInt(lastBeat) < 30000);
            if (!active) {
                console.log(`Auto-removing inactive participant: ${p.name}`);
                localStorage.removeItem(`heartbeat_${p.name}`);
            }
            return active;
        });
        saveGameState();
        renderParticipants();
        updateParticipantCounts();
    }
}, 10000);

// === Fix 4: Manual next call reliability ===
function callNumber() {
    if (gameWon) return;
    if (!availableNumbers || availableNumbers.length === 0) {
        resetCalledNumbers();
    }

    const randomIndex = Math.floor(Math.random() * availableNumbers.length);
    const number = availableNumbers.splice(randomIndex, 1)[0];
    calledNumbers.push(number);

    const currentNumberOrg = document.getElementById('currentNumber');
    if (currentNumberOrg) currentNumberOrg.textContent = number;

    const currentNumberPart = document.getElementById('participantCurrentNumber');
    if (currentNumberPart) currentNumberPart.textContent = number;

    updateCalledNumbersDisplay();
    autoMarkNumber(number);
    saveGameState();

    if (availableNumbers.length === 0) {
        const organizerCallButton = document.getElementById('organizerCallButton');
        if (organizerCallButton) organizerCallButton.disabled = true;
    }
}
</script>
</body>
</html>